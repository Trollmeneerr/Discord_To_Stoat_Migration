<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stoat Migration Setup Console</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #0f1020;
    --bg-soft: #171933;
    --panel: #1e2143;
    --panel-2: #252953;
    --text: #eef1ff;
    --muted: #9aa2c9;
    --line: #3b3f6c;

    --ultra-pink: #f00050;
    --signal-red: #e02030;
    --ready-green: #10c050;
    --cloudy-blue: #2080e0;
    --apricot-yellow: #f0b010;
    --special-purple: #9070f0;

    --ok-bg: rgba(16, 192, 80, 0.16);
    --warn-bg: rgba(240, 176, 16, 0.14);
    --err-bg: rgba(224, 32, 48, 0.18);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    color: var(--text);
    font-family: "Plus Jakarta Sans", sans-serif;
    background:
      radial-gradient(900px 360px at 0% -10%, rgba(240, 0, 80, 0.20), transparent 58%),
      radial-gradient(1000px 420px at 100% -20%, rgba(32, 128, 224, 0.20), transparent 55%),
      linear-gradient(180deg, #0e1022, #0b0c18 55%, #080912);
    padding: 18px;
  }

  .app {
    max-width: 1280px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 290px 1fr;
    gap: 14px;
  }

  .shell {
    background: linear-gradient(180deg, rgba(30, 33, 67, 0.95), rgba(24, 26, 52, 0.95));
    border: 1px solid var(--line);
    border-radius: 14px;
    box-shadow: 0 18px 36px rgba(0, 0, 0, 0.35);
  }

  .sidebar {
    padding: 16px;
  }

  .brand {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 14px;
  }

  .brand-dot {
    width: 13px;
    height: 13px;
    border-radius: 999px;
    background: linear-gradient(120deg, var(--ultra-pink), var(--special-purple));
    box-shadow: 0 0 0 4px rgba(240, 0, 80, 0.18);
  }

  .brand h1 {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 800;
    letter-spacing: 0.02em;
  }

  .brand p {
    margin: 2px 0 0;
    color: var(--muted);
    font-size: 0.78rem;
  }

  .steps-title {
    margin: 14px 0 8px;
    font-size: 0.83rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }

  .steps {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 8px;
  }

  .steps li {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 9px 10px;
    color: #dbe0ff;
    font-size: 0.88rem;
  }

  .steps code {
    font-family: "JetBrains Mono", monospace;
    font-size: 0.79rem;
    color: #c7d0ff;
  }

  .tip {
    margin-top: 12px;
    border-left: 3px solid var(--apricot-yellow);
    background: rgba(240, 176, 16, 0.11);
    border-radius: 8px;
    padding: 9px 10px;
    color: #ffe5ad;
    font-size: 0.82rem;
    line-height: 1.35;
  }

  .main {
    padding: 14px;
    display: grid;
    gap: 12px;
  }

  .header {
    background: linear-gradient(145deg, rgba(144, 112, 240, 0.18), rgba(240, 0, 80, 0.16));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px;
  }

  .header h2 {
    margin: 0;
    font-size: 1.16rem;
  }

  .header p {
    margin: 6px 0 0;
    color: #d2d8ff;
    font-size: 0.91rem;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .card {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 12px;
  }

  .card h3 {
    margin: 0 0 8px;
    font-size: 0.98rem;
  }

  .fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .field {
    display: grid;
    gap: 5px;
  }

  .field label {
    font-size: 0.8rem;
    color: #cad2ff;
    font-weight: 700;
  }

  .input-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 7px;
  }

  input {
    width: 100%;
    border: 1px solid #464a7f;
    background: #12142a;
    color: #edf1ff;
    border-radius: 9px;
    padding: 9px 10px;
    font-size: 0.9rem;
    font-family: inherit;
  }

  input:focus {
    outline: none;
    border-color: var(--cloudy-blue);
    box-shadow: 0 0 0 3px rgba(32, 128, 224, 0.2);
  }

  .tiny-btn {
    border: 1px solid #52588f;
    background: #1d2043;
    color: #dae1ff;
    border-radius: 9px;
    padding: 0 10px;
    cursor: pointer;
    font-size: 0.78rem;
    font-weight: 700;
  }

  .hint {
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 2px;
  }

  .actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .btn {
    border: 0;
    border-radius: 9px;
    padding: 9px 12px;
    color: #fff;
    cursor: pointer;
    font-family: inherit;
    font-weight: 800;
    font-size: 0.84rem;
    letter-spacing: 0.01em;
    transition: transform 0.12s ease, filter 0.12s ease;
  }

  .btn:hover {
    transform: translateY(-1px);
    filter: brightness(1.07);
  }

  .btn:disabled {
    cursor: not-allowed;
    opacity: 0.58;
    transform: none;
  }

  .btn.primary {
    background: linear-gradient(120deg, var(--ultra-pink), #d80d75);
  }

  .btn.secondary {
    background: linear-gradient(120deg, var(--cloudy-blue), #4673ec);
  }

  .btn.success {
    background: linear-gradient(120deg, var(--ready-green), #00a350);
  }

  .btn.warning {
    background: linear-gradient(120deg, var(--signal-red), #c5182f);
  }

  .script-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
  }

  .script {
    text-align: left;
    background: #191c3d;
    border: 1px solid #454a83;
    color: #eaf0ff;
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    font-family: inherit;
  }

  .script strong {
    display: block;
    font-size: 0.89rem;
  }

  .script span {
    color: #b5bce6;
    font-size: 0.76rem;
  }

  .status-box {
    margin-top: 9px;
    border: 1px solid #4a4f87;
    background: #141633;
    border-radius: 9px;
    padding: 9px;
    font-size: 0.83rem;
    color: #cdd5ff;
    white-space: pre-wrap;
    min-height: 62px;
  }

  .status-box.ok {
    border-color: rgba(16, 192, 80, 0.65);
    background: var(--ok-bg);
  }

  .status-box.warn {
    border-color: rgba(240, 176, 16, 0.65);
    background: var(--warn-bg);
  }

  .status-box.err {
    border-color: rgba(224, 32, 48, 0.7);
    background: var(--err-bg);
  }

  .terminal-wrap {
    margin-top: 10px;
    border: 1px solid #44497f;
    border-radius: 12px;
    overflow: hidden;
    background: #0a0c1f;
  }

  .terminal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    background: #121433;
    border-bottom: 1px solid #3a3f6e;
    padding: 8px 10px;
  }

  .terminal-title {
    font-size: 0.8rem;
    color: #c9d1fb;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .pill {
    font-size: 0.74rem;
    font-weight: 800;
    border-radius: 999px;
    padding: 4px 9px;
    border: 1px solid #5a5f9f;
    color: #cfd6ff;
    background: rgba(255, 255, 255, 0.05);
  }

  .pill.running {
    border-color: rgba(16, 192, 80, 0.7);
    color: #b8ffd0;
    background: rgba(16, 192, 80, 0.18);
  }

  .pill.idle {
    border-color: rgba(144, 112, 240, 0.8);
    color: #dfd5ff;
    background: rgba(144, 112, 240, 0.18);
  }

  .pill.error {
    border-color: rgba(224, 32, 48, 0.8);
    color: #ffc9d1;
    background: rgba(224, 32, 48, 0.16);
  }

  .terminal {
    margin: 0;
    min-height: 320px;
    max-height: 56vh;
    overflow: auto;
    padding: 12px;
    white-space: pre-wrap;
    color: #e0e6ff;
    font: 0.84rem/1.36 "JetBrains Mono", monospace;
  }

  .terminal-input {
    width: 100%;
    border: 0;
    border-top: 1px solid #3f4479;
    border-radius: 0;
    background: #0f122e;
    color: #f1f4ff;
    font: 0.84rem "JetBrains Mono", monospace;
    padding: 10px;
  }

  .terminal-input:focus {
    box-shadow: none;
    border-color: #4c5191;
  }

  @media (max-width: 1060px) {
    .app {
      grid-template-columns: 1fr;
    }

    .sidebar {
      order: 2;
    }

    .main {
      order: 1;
    }
  }

  @media (max-width: 780px) {
    body {
      padding: 10px;
    }

    .grid,
    .fields,
    .script-grid {
      grid-template-columns: 1fr;
    }

    .terminal {
      min-height: 250px;
      max-height: 50vh;
    }
  }
</style>
</head>
<body>
<main class="app">
  <aside class="shell sidebar">
    <div class="brand">
      <span class="brand-dot" aria-hidden="true"></span>
      <div>
        <h1>Stoat Setup Console</h1>
        <p>Discord to Stoat migration helper</p>
      </div>
    </div>

    <h2 class="steps-title">Quick Flow</h2>
    <ol class="steps">
      <li>Fill bot values, then click <code>Save .env</code>.</li>
      <li>If needed, click <code>Save + Install</code>.</li>
      <li>Run <code>Discord Scraper</code> and choose your server in terminal.</li>
      <li>Run <code>Stoat Importer</code> and choose the archive database.</li>
    </ol>

    <div class="tip">
      Keep this page open while scripts run. Use the terminal input box when the script asks for a number or confirmation.
    </div>
  </aside>

  <section class="shell main">
    <header class="header">
      <h2>Setup and Migration Runner</h2>
      <p>Styled to match Stoat dark surfaces and accent colors, with guided controls and live terminal output.</p>
    </header>

    <div class="grid">
      <article class="card">
        <h3>Project Configuration</h3>
        <div class="fields">
          <div class="field">
            <label for="discordToken">DISCORD_TOKEN</label>
            <div class="input-row">
              <input id="discordToken" type="password" placeholder="Discord bot token" autocomplete="off" />
              <button class="tiny-btn" id="toggleDiscordToken" type="button">Show</button>
            </div>
            <div class="hint">From Discord developer portal bot settings.</div>
          </div>

          <div class="field">
            <label for="discordLimit">DISCORD_MESSAGE_LIMIT</label>
            <input id="discordLimit" type="text" placeholder="none or positive integer" value="none" />
            <div class="hint">Use <code>none</code> for full history.</div>
          </div>

          <div class="field">
            <label for="stoatToken">STOAT_TOKEN</label>
            <div class="input-row">
              <input id="stoatToken" type="password" placeholder="Stoat bot token" autocomplete="off" />
              <button class="tiny-btn" id="toggleStoatToken" type="button">Show</button>
            </div>
            <div class="hint">From Stoat server bot settings.</div>
          </div>

          <div class="field">
            <label for="stoatServer">STOAT_SERVER_ID</label>
            <input id="stoatServer" type="text" placeholder="Target Stoat server id" />
            <div class="hint">Right click server icon and copy server ID.</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="saveConfigBtn" type="button">Save .env Files</button>
          <button class="btn secondary" id="saveInstallBtn" type="button">Save + Install Dependencies</button>
        </div>

        <div class="status-box warn" id="setupStatus">Ready. Fill values and save configuration.</div>
      </article>

      <article class="card">
        <h3>Script Launcher</h3>
        <div class="script-grid" id="scriptGrid">
          <button class="script" data-target="bot" type="button">
            <strong>Run Discord Scraper</strong>
            <span>Archives Discord server into SQLite</span>
          </button>
          <button class="script" data-target="validate" type="button">
            <strong>Run validate.py</strong>
            <span>Inspect and validate archived data</span>
          </button>
          <button class="script" data-target="importer" type="button">
            <strong>Run Stoat Importer</strong>
            <span>Imports archive into Stoat channels</span>
          </button>
        </div>

        <div class="actions">
          <button class="btn warning" id="stopBtn" type="button">Stop Current Process</button>
          <button class="btn success" id="clearTerminalBtn" type="button">Clear Terminal View</button>
        </div>

        <div class="hint">Only one script can run at a time. Use terminal input below for menu choices.</div>
      </article>
    </div>

    <section class="card">
      <div class="terminal-wrap">
        <div class="terminal-head">
          <span class="terminal-title">Embedded Terminal</span>
          <span class="pill idle" id="terminalState">Idle</span>
        </div>
        <pre class="terminal" id="terminal"></pre>
        <input class="terminal-input" id="terminalInput" type="text" placeholder="Type input for running process and press Enter" />
      </div>
    </section>
  </section>
</main>

<script>
  const terminalEl = document.getElementById("terminal");
  const terminalStateEl = document.getElementById("terminalState");
  const terminalInputEl = document.getElementById("terminalInput");
  const setupStatusEl = document.getElementById("setupStatus");
  const saveConfigBtn = document.getElementById("saveConfigBtn");
  const saveInstallBtn = document.getElementById("saveInstallBtn");
  const stopBtn = document.getElementById("stopBtn");
  const clearTerminalBtn = document.getElementById("clearTerminalBtn");
  const scriptButtons = Array.from(document.querySelectorAll("button[data-target]"));

  const fields = {
    discordToken: document.getElementById("discordToken"),
    discordLimit: document.getElementById("discordLimit"),
    stoatToken: document.getElementById("stoatToken"),
    stoatServer: document.getElementById("stoatServer")
  };

  let pollTimer = null;
  let pollInFlight = false;
  let cursor = 0;
  let processRunning = false;

  function appendTerminal(text) {
    if (!text) {
      return;
    }
    terminalEl.textContent += text;
    terminalEl.scrollTop = terminalEl.scrollHeight;
  }

  function setTerminalState(label, stateClass) {
    terminalStateEl.textContent = label;
    terminalStateEl.classList.remove("idle", "running", "error");
    terminalStateEl.classList.add(stateClass);
  }

  function setStatus(text, type = "warn") {
    setupStatusEl.textContent = text;
    setupStatusEl.classList.remove("ok", "warn", "err");
    setupStatusEl.classList.add(type);
  }

  function setControls(running) {
    processRunning = running;
    scriptButtons.forEach((button) => {
      button.disabled = running;
    });
    stopBtn.disabled = !running;
  }

  function setSaving(isSaving) {
    saveConfigBtn.disabled = isSaving;
    saveInstallBtn.disabled = isSaving;
    if (isSaving) {
      setStatus("Saving configuration...", "warn");
    }
  }

  function toggleTokenVisibility(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    button.addEventListener("click", () => {
      const isPassword = input.type === "password";
      input.type = isPassword ? "text" : "password";
      button.textContent = isPassword ? "Hide" : "Show";
    });
  }

  function validateForm() {
    const discordToken = fields.discordToken.value.trim();
    const limit = fields.discordLimit.value.trim().toLowerCase();
    const stoatToken = fields.stoatToken.value.trim();
    const stoatServer = fields.stoatServer.value.trim();

    if (!discordToken) {
      throw new Error("DISCORD_TOKEN is required.");
    }
    if (!stoatToken) {
      throw new Error("STOAT_TOKEN is required.");
    }
    if (!stoatServer) {
      throw new Error("STOAT_SERVER_ID is required.");
    }
    const isNone = limit === "" || limit === "none";
    const isPositiveInt = /^\d+$/.test(limit) && Number(limit) > 0;
    if (!isNone && !isPositiveInt) {
      throw new Error("DISCORD_MESSAGE_LIMIT must be 'none' or a positive integer.");
    }
  }

  async function api(path, options = {}) {
    const response = await fetch(path, {
      headers: {
        "Content-Type": "application/json"
      },
      ...options
    });

    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data.error || `Request failed with ${response.status}`);
    }
    return data;
  }

  function startPolling() {
    if (pollTimer) {
      return;
    }

    pollTimer = setInterval(async () => {
      if (pollInFlight) {
        return;
      }
      pollInFlight = true;

      try {
        const data = await api(`/api/process/output?cursor=${cursor}`, { method: "GET" });
        cursor = data.cursor;

        if (data.dropped) {
          appendTerminal("\n[older terminal output was truncated]\n");
        }

        appendTerminal(data.output);

        if (data.running) {
          setTerminalState("Running", "running");
          setControls(true);
        } else if (data.exit_code === null) {
          setTerminalState("Idle", "idle");
          setControls(false);
        } else if (data.exit_code === 0) {
          setTerminalState("Exited 0", "idle");
          setControls(false);
        } else {
          setTerminalState(`Exited ${data.exit_code}`, "error");
          setControls(false);
        }
      } catch (error) {
        setTerminalState("Connection Error", "error");
      } finally {
        pollInFlight = false;
      }
    }, 400);
  }

  async function loadConfig() {
    try {
      const data = await api("/api/config", { method: "GET" });
      fields.discordToken.value = data.config.discord_token || "";
      fields.discordLimit.value = data.config.discord_message_limit || "none";
      fields.stoatToken.value = data.config.stoat_token || "";
      fields.stoatServer.value = data.config.stoat_server_id || "";
      setStatus("Loaded existing .env values. Update anything and save.", "ok");
    } catch (error) {
      setStatus(`Could not load existing config: ${error.message}`, "err");
    }
  }

  async function saveConfig(installDependencies) {
    try {
      validateForm();
    } catch (error) {
      setStatus(error.message, "err");
      return;
    }

    setSaving(true);

    try {
      const payload = {
        discord_token: fields.discordToken.value,
        discord_message_limit: fields.discordLimit.value,
        stoat_token: fields.stoatToken.value,
        stoat_server_id: fields.stoatServer.value,
        install_dependencies: installDependencies
      };

      const data = await api("/api/configure", {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const result = data.result;
      let statusText = "Saved Discord_scrape/.env and Stoat_migration/.env.";

      if (result.install_dependencies) {
        statusText += `\nDependency install exit code: ${result.pip_exit_code}`;
        if (result.pip_output) {
          statusText += `\n\n${result.pip_output}`;
        }
      }

      setStatus(statusText, result.pip_exit_code === null || result.pip_exit_code === 0 ? "ok" : "err");
    } catch (error) {
      setStatus(`Setup failed: ${error.message}`, "err");
    } finally {
      setSaving(false);
    }
  }

  async function startProcess(target) {
    if (processRunning) {
      appendTerminal("\n[error] A process is already running. Stop it first.\n");
      return;
    }

    try {
      setTerminalState("Starting", "idle");
      await api("/api/process/start", {
        method: "POST",
        body: JSON.stringify({ target })
      });
      setStatus(`Started ${target}. Watch terminal output below.`, "ok");
    } catch (error) {
      appendTerminal(`\n[error] ${error.message}\n`);
      setTerminalState("Idle", "idle");
      setStatus(`Could not start process: ${error.message}`, "err");
    }
  }

  async function sendInput(text) {
    if (!text && !processRunning) {
      return;
    }

    try {
      await api("/api/process/input", {
        method: "POST",
        body: JSON.stringify({ text })
      });
    } catch (error) {
      appendTerminal(`\n[error] ${error.message}\n`);
    }
  }

  async function stopProcess() {
    if (!processRunning) {
      return;
    }

    try {
      await api("/api/process/stop", {
        method: "POST",
        body: "{}"
      });
      setTerminalState("Stopping", "idle");
      setStatus("Stop signal sent to current process.", "warn");
    } catch (error) {
      appendTerminal(`\n[error] ${error.message}\n`);
      setStatus(`Could not stop process: ${error.message}`, "err");
    }
  }

  saveConfigBtn.addEventListener("click", () => {
    saveConfig(false);
  });

  saveInstallBtn.addEventListener("click", () => {
    saveConfig(true);
  });

  scriptButtons.forEach((button) => {
    button.addEventListener("click", () => {
      startProcess(button.dataset.target);
    });
  });

  stopBtn.addEventListener("click", stopProcess);

  clearTerminalBtn.addEventListener("click", () => {
    terminalEl.textContent = "";
  });

  terminalInputEl.addEventListener("keydown", (event) => {
    if (event.key !== "Enter") {
      return;
    }
    event.preventDefault();
    const value = terminalInputEl.value;
    terminalInputEl.value = "";
    sendInput(value);
  });

  toggleTokenVisibility("discordToken", "toggleDiscordToken");
  toggleTokenVisibility("stoatToken", "toggleStoatToken");

  setControls(false);
  startPolling();
  loadConfig();
</script>
</body>
</html>
